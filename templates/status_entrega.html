<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status de Entrega</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 50px;
        }
        .logo {
            max-width: 150px;
            margin-bottom: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .table-responsive {
            margin-top: 20px;
        }
        .modal-body select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center">
            <img src="{{ url_for('static', filename='imagem/shopee32.png') }}"alt="Logo Empresa" class="logo">
            <h1>Status de Entrega</h1>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Rota</th>
                        <th>Tipo de Entrega</th>
                        <th>Etapa Atual</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in registros %}
                    <tr>
                        <td>{{ registro.id }}</td>
                        <td>{{ registro.nome }}</td>
                        <td>{{ registro.rota }}</td>
                        <td>{{ registro.tipo_entrega }}</td>
                        <td id="etapa-{{ registro.id }}">
                            {{ registro.etapa.nome_etapa if registro.etapa else 'Não Definida' }}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary"
                                data-toggle="modal" data-target="#updateEtapaModal"
                                data-registro-id="{{ registro.id }}"
                                data-current-etapa-id="{{ registro.etapa.id if registro.etapa else '' }}">
                                Atualizar Etapa
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="updateEtapaModal" tabindex="-1" role="dialog" aria-labelledby="updateEtapaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateEtapaModalLabel">Atualizar Etapa do Registro</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalRegistroId">
                    <label for="etapaSelect">Selecione a Nova Etapa:</label>
                    <select class="form-control" id="etapaSelect">
                        </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="saveEtapaBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let allEtapas = []; // Para armazenar todas as etapas disponíveis

        $(document).ready(function() {
            // Carrega as etapas quando a página é carregada
            fetch('/api/etapas')
                .then(response => response.json())
                .then(data => {
                    allEtapas = data; // Armazena as etapas
                    populateEtapasDropdown();
                })
                .catch(error => console.error('Erro ao carregar etapas:', error));

            // Quando o modal de atualização de etapa é aberto
            $('#updateEtapaModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget); // Botão que acionou o modal
                const registroId = button.data('registro-id');
                const currentEtapaId = button.data('current-etapa-id');

                const modal = $(this);
                modal.find('#modalRegistroId').val(registroId);

                // Preenche o dropdown com todas as etapas
                populateEtapasDropdown(currentEtapaId);
            });

            // Lógica para salvar a nova etapa
            $('#saveEtapaBtn').on('click', function() {
                const registroId = $('#modalRegistroId').val();
                const novaEtapaId = $('#etapaSelect').val();

                fetch(`/api/atualizar_etapa_registro/${registroId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nova_etapa_id: novaEtapaId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // Atualiza a célula da tabela na página sem recarregar
                        $(`#etapa-${registroId}`).text(data.etapa_nome);
                        $('#updateEtapaModal').modal('hide'); // Fecha o modal
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao atualizar etapa:', error);
                    alert('Erro de comunicação com o servidor.');
                });
            });
        });

        function populateEtapasDropdown(currentEtapaId = null) {
            const etapaSelect = $('#etapaSelect');
            etapaSelect.empty(); // Limpa opções antigas

            allEtapas.forEach(etapa => {
                const option = $('<option></option>')
                    .val(etapa.id)
                    .text(etapa.nome);
                if (currentEtapaId && etapa.id == currentEtapaId) {
                    option.attr('selected', 'selected');
                }
                etapaSelect.append(option);
            });
        }
    </script>
</body>
</html>