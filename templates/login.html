<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Fila de Carregamento</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        /* (CSS permanece igual ao que você já tem) */
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .logo-container {
            margin-bottom: 20px;
        }
        .logo {
            width: 120px;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            object-fit: cover;
        }
        .card {
            background: #fff;
            padding: 30px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        button {
            background-color: #ff3c00;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.3s;
        }
        button:disabled {
            background-color: #cccccc; /* Estilo para botão desabilitado */
            cursor: not-allowed;
        }
        button:hover:not(:disabled) { /* Hover apenas quando não estiver desabilitado */
            background-color: #0056b3;
        }
        .erro, #locationMessage, #rotaErrorMessage { /* Adicionado ID rotaErrorMessage para estilização */
            color: red;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }
        .location-success { /* Nova classe para mensagem de sucesso de localização */
            color: green;
        }
        .cadastro-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }
        .cadastro-link a {
            color: #007bff;
            text-decoration: none;
        }
        .cadastro-link a:hover {
            text-decoration: underline;
        }
        @media (max-width: 480px) {
            .card {
                margin: 20px;
                padding: 20px;
            }
            input, select, button {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

    <div class="logo-container">
        <img src="{{ url_for('static', filename='imagem/shopee32.png') }}" alt="shopee32" class="logo">
    </div>

    <div class="card">
        <h2>Fila de Carregamento</h2>

        {% if erro %}
            <p class="erro">{{ erro }}</p>
        {% endif %}

        <form id="loginForm" method="POST">
            <label for="matricula">Matrícula</label>
            <input type="text" id="matricula" name="matricula" required>

            <label for="nome">Nome</label>
            <input type="text" id="nome" name="nome" readonly required>

            <label for="rota">Rota</label>
            <input type="text" id="rota" name="rota" required placeholder="Ex.: A-01">
            <p id="rotaErrorMessage"></p> <label for="tipo_entrega">Tipo de Entrega</label>
            <select id="tipo_entrega" name="tipo_entrega" required>
                <option value="" disabled selected>Selecione</option>
                <option value="Normal">Normal</option>
                <option value="No-Show">No-Show</option>
            </select>

            <label for="cidade_entrega">Cidade de Entrega</label>
            <input type="text" id="cidade_entrega" name="cidade_entrega" list="lista_cidades" autocomplete="off" required>
            <datalist id="lista_cidades"></datalist>

            <p id="locationMessage"></p> 

            <button type="submit" id="submitButton" disabled>Entrar</button>
        </form>

        <div class="cadastro-link">
            Não tem cadastro? <a href="{{ url_for('cadastro') }}">Cadastre-se</a>
        </div>
    </div>

    <script>
        // Coordenadas do local de referência (SPX Express Shopee - Divinópolis)
        const LOCAL_REFERENCIA = {
            latitude: -20.1706692, // Latitude aproximada do local
            longitude: -44.8967584  // Longitude aproximada do local
        };
        const RAIO_PERMITIDO_METROS = 10; // 10 metros

        // Elementos do DOM
        const matriculaInput = document.getElementById('matricula');
        const nomeInput = document.getElementById('nome');
        const rotaInput = document.getElementById('rota'); // Novo elemento
        const submitButton = document.getElementById('submitButton');
        const loginForm = document.getElementById('loginForm');
        const locationMessage = document.getElementById('locationMessage');
        const rotaErrorMessage = document.getElementById('rotaErrorMessage'); // Novo elemento

        let usuarioProximo = false;
        let matriculaValida = false;
        let rotaValida = false; // Nova flag para validação da rota

        // Função para calcular a distância entre duas coordenadas (Fórmula de Haversine)
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Raio da Terra em metros
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distância em metros
        }

        // Função para atualizar o estado do botão de submit
        function atualizarBotaoSubmit() {
            submitButton.disabled = !(usuarioProximo && matriculaValida && rotaValida);
        }

        // --- Lógica de Geolocalização ---
        function obterLocalizacao() {
            if (navigator.geolocation) {
                locationMessage.textContent = "Obtendo sua localização...";
                locationMessage.className = "";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        const distancia = calcularDistancia(
                            userLat, userLon,
                            LOCAL_REFERENCIA.latitude, LOCAL_REFERENCIA.longitude
                        );

                        if (distancia <= RAIO_PERMITIDO_METROS) {
                            usuarioProximo = true;
                            locationMessage.textContent = "Você está próximo ao local. Prossiga com o login.";
                            locationMessage.className = "location-success";
                        } else {
                            usuarioProximo = false;
                            locationMessage.textContent = `Você está a ${distancia.toFixed(2)} metros do local. É necessário estar a até ${RAIO_PERMITIDO_METROS} metros para logar.`;
                            locationMessage.className = "erro";
                        }
                        atualizarBotaoSubmit();
                    },
                    (error) => {
                        usuarioProximo = false;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                locationMessage.textContent = "Acesso à localização negado. O login não pode ser realizado.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                locationMessage.textContent = "Informações de localização indisponíveis.";
                                break;
                            case error.TIMEOUT:
                                locationMessage.textContent = "Tempo limite para obter a localização esgotado.";
                                break;
                            default:
                                locationMessage.textContent = "Erro desconhecido ao obter a localização.";
                                break;
                        }
                        locationMessage.className = "erro";
                        atualizarBotaoSubmit();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                usuarioProximo = false;
                locationMessage.textContent = "Seu navegador não suporta geolocalização. O login não pode ser realizado.";
                locationMessage.className = "erro";
                atualizarBotaoSubmit();
            }
        }

        // --- Lógica de Busca de Nome e Autocomplete de Cidades (já existente) ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function buscarNome() {
            const matricula = matriculaInput.value.trim();

            if (!matricula) {
                nomeInput.value = '';
                matriculaValida = false;
                atualizarBotaoSubmit();
                return;
            }

            fetch('/buscar_nome', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ matricula: matricula })
            })
            .then(response => {
                if (!response.ok) throw new Error('Erro na resposta do servidor');
                return response.json();
            })
            .then(data => {
                if (data.nome) {
                    nomeInput.value = data.nome;
                    matriculaValida = true;
                } else {
                    nomeInput.value = 'Matrícula não encontrada! Faça seu cadastro!';
                    matriculaValida = false;
                }
                atualizarBotaoSubmit();
            })
            .catch(error => {
                console.error('Erro ao buscar nome:', error);
                nomeInput.value = 'Erro ao buscar nome!';
                matriculaValida = false;
                atualizarBotaoSubmit();
            });
        }

        matriculaInput.addEventListener('input', debounce(buscarNome, 500));

        const inputCidade = document.getElementById('cidade_entrega');
        const datalist = document.getElementById('lista_cidades');

        inputCidade.addEventListener('input', function () {
            const termo = this.value;
            if (termo.length < 2) return;

            fetch(`/buscar_cidades?termo=${encodeURIComponent(termo)}`)
                .then(response => response.json())
                .then(cidades => {
                    datalist.innerHTML = '';
                    cidades.forEach(cidade => {
                        const option = document.createElement('option');
                        option.value = cidade;
                        datalist.appendChild(option);
                    });
                });
        });

        // --- Nova Lógica de Validação da Rota ---
        rotaInput.addEventListener('input', () => {
            const rota = rotaInput.value.trim().toUpperCase(); // Converte para maiúsculas para padronizar
            // Expressão regular para A-01 (Letra-NúmeroNúmero)
            // ^[A-Z]$ : Começa com uma letra maiúscula
            // - : seguido por um hífen
            // \d{2}$ : seguido por exatamente dois dígitos e termina a string
            const regexRota = /^[A-Z]-\d{2}$/;

            if (regexRota.test(rota)) {
                rotaValida = true;
                rotaErrorMessage.textContent = ""; // Limpa a mensagem de erro
                rotaInput.value = rota; // Garante que o valor no campo está padronizado (maiúsculas)
            } else {
                rotaValida = false;
                rotaErrorMessage.textContent = "Formato inválido. Use 'A-01'.";
            }
            atualizarBotaoSubmit();
        });

        // --- Lógica de Envio do Formulário ---
        loginForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Evita o envio padrão do formulário

            // Revalida as condições antes de enviar
            if (usuarioProximo && matriculaValida && rotaValida) {
                const formData = new FormData(loginForm);
                const data = Object.fromEntries(formData.entries());

                // IMPORTANTE: Envie a localização REAL do usuário (se obtida) para validação no servidor.
                // Por exemplo, você pode armazenar userLat e userLon em variáveis globais após obtê-las
                // e adicioná-las aqui:
                // data.userLatitude = userLatGlobal;
                // data.userLongitude = userLonGlobal;

                fetch(loginForm.action, {
                    method: loginForm.method,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(data).toString()
                })
                .then(response => {
                    if (response.ok) {
                        alert("Login efetuado com sucesso! Redirecionando...");
                        // window.location.href = "/pagina_de_destino";
                        return response.text();
                    } else {
                        alert("Erro no login ou na validação do servidor. Verifique o console.");
                        console.error('Erro de servidor:', response.status, response.statusText);
                    }
                })
                .then(result => console.log('Resposta do servidor:', result))
                .catch(error => {
                    console.error('Erro de rede ou processamento:', error);
                    alert("Ocorreu um erro ao tentar logar.");
                });

            } else {
                // Mensagens mais específicas para o usuário
                if (!matriculaValida) {
                    alert("Matrícula inválida ou não encontrada. Verifique e tente novamente.");
                } else if (!rotaValida) {
                    alert("Formato da Rota inválido. Por favor, use o formato 'A-01'.");
                } else if (!usuarioProximo) {
                    alert("Você não está próximo o suficiente do local para logar.");
                }
            }
        });

        // Inicia a obtenção da localização assim que a página é carregada
        obterLocalizacao();
    </script>

</body>
</html>