<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Registros No Show</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ESTILOS DE LAYOUT GLOBAIS */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex; /* Permite layout flexível com sidebar e conteúdo */
            min-height: 100vh;
            overflow-x: hidden; /* Evita rolagem horizontal durante a transição */
        }

        /* Estilos do Menu Lateral (Sidebar) */
        .sidebar {
            height: 100%;
            width: 250px; /* Largura padrão para desktop */
            position: fixed; /* Fixa o sidebar na tela */
            z-index: 1000; /* Garante que fique acima de outros elementos */
            top: 0;
            left: 0;
            background-color: #343a40; /* Cor de fundo escura */
            overflow-x: hidden;
            transition: transform 0.5s ease; /* Transição suave para esconder/mostrar */
            padding-top: 20px; /* Espaço do topo */
            box-shadow: 2px 0 5px rgba(0,0,0,0.5); /* Sombra para profundidade */
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centraliza itens como logo e título */
            justify-content: flex-start;
            transform: translateX(-250px); /* Padrão: sidebar escondido em mobile e inicialização */
        }

        .sidebar.open {
            transform: translateX(0); /* Mostra o sidebar */
        }

        .sidebar .logo-sidebar {
            width: 120px; /* Tamanho da logo na sidebar */
            margin-bottom: 20px;
            border-radius: 8px; /* Cantos arredondados */
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); /* Sombra */
        }

        .sidebar h2.menu-title { /* Título do menu na sidebar */
            color: white;
            margin-bottom: 20px;
            font-size: 1.4em; /* Tamanho do título do menu */
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
            width: 100%;
        }

        .sidebar ul li a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 1.1em;
            color: #f8f9fa;
            display: flex; /* Para alinhar ícone e texto */
            align-items: center; /* Para alinhar verticalmente */
            transition: 0.3s;
            text-align: left; /* Alinhar texto à esquerda */
        }

        .sidebar ul li a i { /* Estilo para os ícones */
            margin-right: 10px; /* Espaço entre ícone e texto */
        }

        .sidebar ul li a:hover {
            background-color: #007bff; /* Cor de destaque ao passar o mouse */
            color: white;
        }
        
        /* Estilos do Conteúdo Principal */
        .main-content-wrapper { /* Novo wrapper para o conteúdo da página, para permitir o deslocamento */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-left: 0; /* Padrão: sem margem à esquerda */
            transition: margin-left 0.5s ease; /* Transição suave */
            width: 100%; /* Ocupa a largura total */
        }

        .main-content-wrapper.shifted {
            margin-left: 250px; /* Espaço para o sidebar visível em desktop */
        }

        /* Overlay para fechar o menu ao clicar fora */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999; 
            display: none; 
        }

        /* Banner */
        .banner {
            background-color: #f11a0a;
            padding: 10px 20px;
            display: flex;
            flex-direction: column; /* Alinha os itens em coluna por padrão */
            align-items: flex-start; /* Alinha os itens à esquerda */
            gap: 10px; /* Espaçamento entre os itens */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative; /* Ajuste para que o z-index funcione se necessário */
            z-index: 1; /* Garante que o banner esteja acima do conteúdo principal mas abaixo do sidebar/overlay */
            width: 100%; /* Ocupa a largura total */
            box-sizing: border-box; /* Inclui padding no cálculo da largura */
        }

        .banner .logo {
            height: 60px;
            width: auto;
            border-radius: 8px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
            margin-bottom: 10px; /* Espaço abaixo da logo */
        }

        .banner h1 {
            font-size: 2em;
            color: white;
            margin: 0; /* Remove margens padrão */
            text-align: center; /* Centraliza o título */
            width: 100%; /* Ocupa a largura total */
        }

        /* Botão de toggle do sidebar dentro do banner */
        .sidebar-toggle {
            background: none;
            border: none;
            color: #f8f9fa;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        /* Estilos de filtros */
        .filters {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            justify-content: flex-start;
            width: 100%;
        }

        .filters label {
            color: white;
            font-size: 14px;
        }

        .filters input[type="date"],
        .filters input[type="text"],
        .filters select,
        .filters button {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            background-color: #fff;
            color: #282929;
            width: auto;
            min-width: 100px;
        }

        .filters button {
            background-color: #282929;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .filters button:hover {
            background-color: #5b5c5c;
        }

        .clear-filters {
            background-color: #6b7280; /* Tailwind gray-500 */
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .clear-filters:hover {
            background-color: #4b5563; /* Tailwind gray-600 */
        }

        /* Container para flash messages, cards e paginação */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto; /* Espaçamento do banner e centralização */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Flash messages */
        .flash-messages {
            margin-bottom: 20px;
        }
        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #34d399; }
        .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
        .alert-warning { background-color: #fffbeb; color: #92400e; border: 1px solid #fbbf24; }

        /* Cards */
        .cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .card {
            width: 250px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 2px solid transparent;
            box-sizing: border-box;
        }

        .card p {
            margin: 4px 0;
            font-size: 13px;
            color: #333;
        }

        .card p strong {
            font-weight: 600;
            color: #1f2937;
        }

        /* Status Labels */
        .status-label {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            z-index: 10;
        }
        .status-aguardando { background-color: #f59e0b; }
        .status-separacao { background-color: #dc2626; }
        .status-aguardando-entregador { background-color: #f59e0b; }
        .status-finalizado { background-color: #10b981; }
        .status-cancelado { background-color: #ef4444; }
        .status-transferido { background-color: #3b82f6; }

        /* Card Actions */
        .card-actions {
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            display: flex;
            flex-direction: column; /* Coluna para alinhar verticalmente os formulários */
            gap: 0.75rem;
            align-items: center; /* Centraliza os formulários */
        }

        .card-actions form {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            justify-content: center; /* Centraliza os itens dentro de cada formulário */
            width: 100%; /* Garante que o formulário ocupe a largura disponível */
        }

        .card-actions form input[type="text"] {
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            width: calc(50% - 0.25rem); /* Ajuste para 2 inputs por linha em desktop */
            box-sizing: border-box;
        }

        .card-actions form button {
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            width: 150px; /* Largura fixa para botões */
            box-sizing: border-box;
            text-align: center;
        }

        .card-actions form button:hover {
            filter: brightness(90%);
        }

        .btn-associar { background-color: #22c55e; }
        .btn-associar:disabled { background-color: #a5d6a7; cursor: not-allowed; opacity: 0.6; }
        .btn-cancelar { background-color: #ef4444; }
        .btn-transferir { background-color: #3b82f6; }
        .btn-finalizar { background-color: #02ea15; }

        /* Paginação */
        .paginacao {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .paginacao a, .paginacao strong {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.2s;
        }

        .paginacao a:hover {
            background-color: #eee;
        }

        .paginacao strong {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            display: none;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }
        .message-box button {
            margin-top: 15px;
            padding: 8px 15px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Media Queries para responsividade */
        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
                transform: translateX(-180px);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content-wrapper.shifted {
                margin-left: 0;
            }
            .banner {
                flex-direction: column;
                align-items: flex-start;
            }
            .banner h1 {
                font-size: 1.5em; /* Ajuste para mobile */
            }
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            .filters input,
            .filters select,
            .filters button,
            .clear-filters {
                width: 100%;
                min-width: auto;
            }
            .card-actions form input[type="text"] {
                width: 100%; /* Inputs em largura total em mobile */
            }
            .card-actions form button {
                width: 100%; /* Botões em largura total em mobile */
            }
        }
    </style>
</head>
<body>
    <!-- Menu Lateral (Sidebar) -->
    <aside class="sidebar" id="sidebar">
        <!-- Substitua 'imagem/shopee32.png' pelo caminho real da sua logo para o sidebar -->
        <img src="{{ url_for('static', filename='imagem/shopee32.png') }}"
             onerror="this.onerror=null; this.src='https://placehold.co/120x120/343a40/ffffff?text=LOGO';"
             alt="Logo SysSPX" class="logo-sidebar">
        <h2 class="menu-title">Menu</h2>
      <ul>
            {# Links de menu comuns a todas as páginas, usando a estrutura do sidebar com ícones #}
            <li><a href="{{ url_for('menu_principal') }}"><i class="fas fa-home"></i> Página Inicial</a></li>
            <li><a href="{{ url_for('registros') }}"><i class="fas fa-clipboard-list"></i> Painel do Operador</a></li>
            <li><a href="{{ url_for('registro_no_show') }}"><i class="fas fa-list-alt"></i> Listar Registros No-Show</a></li>
            <li><a href="{{ url_for('associacao_no_show') }}"><i class="fas fa-clipboard-check"></i> Criar Registro No-Show</a></li>
            <li><a href="{{ url_for('registros_finalizados') }}"><i class="fas fa-file-alt"></i> Relatório de Registros</a></li>
            <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('painel_gerencial') }}"><i class="fas fa-chart-line"></i>Gerenciamento de Rota</a></li>
            {% endif %}
            <li><a href="{{ url_for('pacotes_rota') }}"><i class="fas fa-route"></i> Pacotes por Rota</a></li>
            <li><a href="{{ url_for('listar_registros') }}"><i class="fas fa-list-alt"></i> Listar Registros (Filtro)</a></li>
            <li><a href="{{ url_for('gerenciar_usuarios') }}"><i class="fas fa-users-cog"></i> Gerenciar Usuários</a></li>
            <li><a href="{{ url_for('cadastro_usuario') }}"><i class="fas fa-user-plus"></i> Cadastrar Novo Usuário</a></li>
            <li><a href="{{ url_for('log_atividades') }}"><i class="fas fa-clipboard-list"></i> Log de Atividades</a></li>
            <li><a href="{{ url_for('status_entrega') }}"><i class="fas fa-truck"></i> Entregas Por Motorista</a></li>
            <li><a href="{{ url_for('adicionar_situacao_pedido') }}"><i class="fas fa-tags"></i> Situação dos Pedidos</a></li>
            <li><a href="{{ url_for('adicionar_etapa') }}"><i class="fas fa-truck-ramp-box"></i> Etapas da Entrega</a></li>
            <li><a href="{{ url_for('menu_principal') }}"><i class="fas fa-cog"></i> Configurações</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            {% else %}
                <li><a href="{{ url_for('login2') }}"><i class="fas fa-sign-in-alt"></i> Login Sistema</a></li>
            {% endif %}
        </ul>
    </aside>

    {# Overlay para fechar o menu ao clicar fora #}
    <div class="overlay" id="overlay"></div>

    <!-- Conteúdo Principal da Página (Agora encapsulado para deslocamento) -->
    <div id="mainContentWrapper" class="main-content-wrapper">
        <div class="banner">
            <img src="{{ url_for('static', filename='imagem/shopee32.png') }}" class="logo" alt="Logo Shopee">
            <h1>Registros No Show - Sistema de Gerenciamento Operacional</h1>
            <form action="{{ url_for('registro_no_show') }}" method="GET" class="filters">
                <button type="button" class="sidebar-toggle" id="sidebarToggle">☰</button>

                <label for="data">Data:</label>
                <input type="date" id="data" name="data" value="{{ data_filtro or '' }}">

                <label for="nome">Nome:</label>
                <input type="text" id="nome" name="nome" placeholder="Nome" value="{{ nome_filtro or '' }}">

                <label for="matricula">Matrícula:</label>
                <input type="text" id="matricula" name="matricula" placeholder="Matrícula" value="{{ matricula_filtro or '' }}">

                <label for="rota">Rota:</label>
                <input type="text" id="rota" name="rota" placeholder="Rota" value="{{ rota_filtro or '' }}">

                <label for="status">Status:</label>
                <select id="status" name="status">
                    <option value="">Todos</option>
                    <option value="finalizado" {% if status_filtro == 'finalizado' %}selected{% endif %}>Finalizado</option>
                    <option value="transferido" {% if status_filtro == 'transferido' %}selected{% endif %}>Transferido</option>
                    <option value="cancelado" {% if status_filtro == 'cancelado' %}selected{% endif %}>Cancelado</option>
                    <option value="em_separacao_1" {% if status_filtro == 'em_separacao_1' %}selected{% endif %}>Em Separação</option>
                    <option value="aguardando_entregador_2" {% if status_filtro == 'aguardando_entregador_2' %}selected{% endif %}>Aguardando Entregador</option>
                    <option value="aguardando_motorista" {% if status_filtro == 'aguardando_motorista' %}selected{% endif %}>Aguardando Motorista</option>
                </select>

                <button type="submit">Filtrar</button>
                <a href="{{ url_for('registro_no_show') }}" class="clear-filters">Limpar Filtros</a>
            </form>
        </div>


        <div class="container">
            {# Display flash messages #}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="cards">
                {% if registros_no_show %}
                    {% for registro in registros_no_show %}
                        {# Condição para exibir o card: só mostra se não for cancelado nem finalizado por padrão, OU se o filtro de status corresponder #}
                        {% if (registro.cancelado != 1 and registro.finalizada != 1) or status_filtro == 'cancelado' or status_filtro == 'finalizado' or status_filtro == 'transferido' or status_filtro == 'em_separacao_1' or status_filtro == 'aguardando_entregador_2' or status_filtro == 'aguardando_motorista' %}
                            {# Add ID to the card div for scrolling #}
                            <div class="card" id="no-show-registro-{{ registro.id }}">
                                {# Status Label - This already correctly shows "Cancelado" and "Finalizado" #}
                                {% if registro.finalizada == 1 %}
                                    <span class="status-label status-finalizado">Finalizado</span>
                                {% elif registro.cancelado == 1 or registro.em_separacao == 3 %}
                                    <span class="status-label status-cancelado">Cancelado</span>
                                {% elif registro.em_separacao == 1 %}
                                    <span class="status-label status-separacao">Em Separação</span>
                                {% elif registro.em_separacao == 2 %}
                                    <span class="status-label status-aguardando-entregador">Aguardando Entregador</span>
                                {% elif registro.em_separacao == 4 %} {# Novo status para Transferido #}
                                    <span class="status-label status-transferido">Transferido</span>
                                {% else %}
                                    <span class="status-label status-aguardando">Aguardando Motorista</span>
                                {% endif %}
                                {# BEGIN - Display fields in the desired order #}
                                <p><strong>Data/Hora:</strong> {{ registro.data_hora_login | formata_data_hora }}</p>
                                <p><strong>Nome:</strong> {{ registro.nome | default('N/A') }}</p>
                                <p><strong>Matrícula:</strong> {{ registro.matricula | default('N/A') }}</p>
                                <p><strong>Rota:</strong> {{ registro.gaiola | default('N/A') }}</p> {# Using gaiola as discussed, assuming it's the display Rota #}
                                <p><strong>Entrega:</strong> {{ registro.tipo_entrega | default('N/A') }}</p>
                                <p><strong>Rua:</strong> {{ registro.rua | default('N/A') }}</p>
                                <p><strong>Estação:</strong> {{ registro.estacao | default('N/A') }}</p>

                                {# Modified line for Finalizado text to show time if finalized, "Cancelado" if canceled, or "Não Finalizado" #}
                                <p><strong>Data \ Hora Fim:</strong>
                                    {% if registro.finalizada == 1 %}
                                        {{ registro.hora_finalizacao|formata_data_hora }}
                                    {% elif registro.cancelado == 1 or registro.em_separacao == 3 %}
                                        Cancelado
                                    {% elif registro.em_separacao == 4 %} {# Adicionada condição para status Transferido #}
                                        {{ registro.hora_finalizacao|formata_data_hora }} {# Exibe a hora de finalização para Transferido #}
                                    {% else %}
                                        Não Finalizado
                                    {% endif %}
                                </p>
                                {# END - Display fields in the desired order #}

                                {# Action Forms Section - Display all actions regardless of status #}
                                <div class="card-actions">
                                    {# Forms for active records #}
                                    {% if not registro.gaiola or not registro.estacao %}
                                        {# Form to Associate #}
                                        <form action="{{ url_for('associar_id', id=registro.id) }}" method="POST">
                                            <input type="text" name="gaiola" placeholder="Rota:" required class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                            <input type="text" name="estacao" placeholder="Estação:" required class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                            <input type="text" name="rua" placeholder="Rua:" value="{% if registro.rua and registro.rua != 'None' %}{{ registro.rua }}{% endif %}" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                            <button type="submit" class="btn-associar rounded-md shadow-sm text-white font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" {% if registro.em_separacao == 4 or registro.em_separacao == 3 %}disabled{% endif %}>Associar</button>
                                        </form>
                                    {% endif %}
                                    <form action="{{ url_for('cancelar_no_show', id=registro.id, data=data_filtro, nome=nome_filtro, matricula=matricula_filtro, rota=rota_filtro, status=status_filtro) }}" method="POST" class="inline-block mr-2 cancelar-noshow-form" data-registro-id="{{ registro.id }}">
                                        <button type="submit" class="btn-cancelar cancelar-noshow-btn" {% if registro.em_separacao == 4 or registro.em_separacao == 3 %}disabled{% endif %}>Cancelar</button>
                                    </form>
                                    <form action="{{ url_for('transferir_no_show_para_registro', no_show_id=registro.id, data=data_filtro, nome=nome_filtro, matricula=matricula_filtro, rota=rota_filtro, status=status_filtro) }}" method="POST" class="transferir-destaque">
                                        <button type="submit" class="btn-transferir" {% if registro.em_separacao == 4 or registro.em_separacao == 3 %}disabled{% endif %}>Transferir</button>
                                    </form>
                                    {% if registro.em_separacao == 4 %}
                                        {# Botão "Finalizar" só aparece após a transferência #}
                                        <form action="{{ url_for('finalizar_no_show', id=registro.id) }}" method="POST">
                                            <button type="submit" class="btn-finalizar">Finalizar</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-center text-gray-600 mt-8">Nenhum registro de No-Show encontrado com os filtros aplicados.</p>
                {% endif %}
            </div>
            <div class="paginacao">
                {% if total_paginas > 1 %}
                    <span>Página {{ pagina }} de {{ total_paginas }}</span>
                    <br>
                    {% if pagina > 1 %}
                        <a href="{{ url_for('associacao', pagina=pagina-1, rota=rota, tipo_entrega=tipo_entrega) }}">Anterior</a>
                    {% endif %}
                    {% for p in range(1, total_paginas + 1) %}
                        {% if p == pagina %}
                            <strong>{{ p }}</strong>
                        {% elif p >= pagina - 2 and p <= pagina + 2 %}
                            <a href="{{ url_for('associacao', pagina=p, rota=rota, tipo_entrega=tipo_entrega) }}">{{ p }}</a>
                        {% elif p == 1 or p == total_paginas or (p == pagina - 3 and pagina > 4) or (p == pagina + 3 and pagina < total_paginas - 3) %}
                            ...
                        {% endif %}
                    {% endfor %}
                    {% if pagina < total_paginas %}
                        <a href="{{ url_for('associacao', pagina=pagina+1, rota=rota, tipo_entrega=tipo_entrega) }}">Próxima</a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    {# Message Box HTML (mantido, pois é um substituto para alert()) #}
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button onclick="document.getElementById('messageBox').style.display='none';">OK</button>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const overlay = document.getElementById('overlay');
        const mainContentWrapper = document.getElementById('mainContentWrapper'); // O novo wrapper

        // Abre o menu
        function openSidebar() {
            sidebar.classList.add('open');
            overlay.style.display = 'block';
            if (window.innerWidth > 768) { // Apenas em desktop
                mainContentWrapper.classList.add('shifted');
            }
        }

        // Fecha o menu
        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.style.display = 'none';
            if (window.innerWidth > 768) { // Apenas em desktop
                mainContentWrapper.classList.remove('shifted');
            }
        }

        // Event listeners para abrir/fechar o menu
        sidebarToggle.addEventListener('click', function(event) {
            event.stopPropagation(); // Impede que o clique se propague para o overlay
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        });
        overlay.addEventListener('click', closeSidebar); // Fecha ao clicar no overlay

        // Função para ajustar o layout ao redimensionar a janela
        function updateLayoutBasedOnScreenSize() {
            if (window.innerWidth <= 768) { // Mobile
                sidebar.classList.remove('open');
                overlay.style.display = 'none';
                mainContentWrapper.classList.remove('shifted'); // Garante que não está deslocado em mobile
            } else { // Desktop
                // Decide se o sidebar deve estar aberto por padrão no desktop
                // Se você quer que ele esteja sempre aberto em desktop, adicione:
                // sidebar.classList.add('open');
                // mainContentWrapper.classList.add('shifted');
            }
        }

        // Fecha o menu se a janela for redimensionada para uma largura maior (opcional, já incluído em updateLayoutBasedOnScreenSize)
        window.addEventListener('resize', updateLayoutBasedOnScreenSize);

        // Chame a função uma vez ao carregar para definir o estado inicial do layout
        updateLayoutBasedOnScreenSize();


        // Funções formatarDataHora e showMessage (mantidas do seu código anterior)
        function formatarDataHora(isoString) {
            if (!isoString || isoString === 'N/A' || isoString.toString().trim() === '') {
                return 'Não Finalizado';
            }
            try {
                let date = new Date(isoString);

                if (isNaN(date.getTime())) {
                    let cleanedIsoString = isoString.replace(' - ', ' ');
                    const parts = cleanedIsoString.split(' ');
                    if (parts.length === 2) {
                        const dateParts = parts[0].split('-');
                        const timeParts = parts[1].split(':');
                        if (dateParts.length === 3 && timeParts.length >= 2) {
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1; 
                            const day = parseInt(dateParts[2]);
                            const hours = parseInt(timeParts[0]);
                            const minutes = parseInt(timeParts[1]);
                            const seconds = timeParts.length > 2 ? parseInt(timeParts[2]) : 0;
                            date = new Date(year, month, day, hours, minutes, seconds);
                        }
                    }
                    if (isNaN(date.getTime())) {
                        const partsDMY = isoString.split(' ');
                        if (partsDMY.length >= 2) {
                            const datePartsDMY = partsDMY[0].split('-');
                            const timePartsDMY = partsDMY[1].split(':');
                            if (datePartsDMY.length === 3 && timePartsDMY.length >= 2) {
                                const day = parseInt(datePartsDMY[0]);
                                const month = parseInt(datePartsDMY[1]) - 1;
                                const year = parseInt(datePartsDMY[2]);
                                const hours = parseInt(timePartsDMY[0]);
                                const minutes = parseInt(timePartsDMY[1]);
                                const seconds = timePartsDMY.length > 2 ? parseInt(timeParts[2]) : 0;
                                date = new Date(year, month, day, hours, minutes, seconds);
                            }
                        }
                        if (isNaN(date.getTime())) {
                            console.warn(`Could not parse date string: ${isoString}`);
                            return 'Formato Inválido';
                        }
                    }
                }

                const formattedDay = String(date.getDate()).padStart(2, '0');
                const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
                const formattedYear = date.getFullYear();
                const formattedHours = String(date.getHours()).padStart(2, '0');
                const formattedMinutes = String(date.getMinutes()).padStart(2, '0');
                const formattedSeconds = String(date.getSeconds()).padStart(2, '0');

                return `${formattedDay}/${formattedMonth}/${formattedYear} ${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
            } catch (e) {
                console.error("Erro ao formatar data/hora:", e);
                return 'Formato Inválido';
            }
        }

        function showMessage(message) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            if (messageBox && messageText) {
                messageText.innerText = message;
                messageBox.style.display = 'block';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 5000); // Esconde após 5 segundos
            } else {
                alert(message); // Fallback
            }
        }

        // Lógica de foco em input (mantida)
        if (window.location.hash) {
            try {
                const el = document.querySelector(window.location.hash);
                if (el) {
                    el.scrollIntoView({ behavior: 'auto', block: 'center' });
                    const firstTextInput = el.querySelector('input[type="text"]:not(:disabled)');
                    if (firstTextInput) {
                        firstTextInput.focus();
                    }
                }
            } catch (e) {
                console.error("Failed to scroll to element:", e);
            }
        } else {
            const firstTextInput = document.querySelector('.card:not(.finalizado-definitivo) input[type="text"]:not(:disabled)');
            if (firstTextInput) {
                firstTextInput.focus();
            }
        }

        // Lógica de "Associar" manual (mantida, mas o alerta original será substituído por showMessage)
        const associateButtons = document.querySelectorAll('.js-disable-manual-associate');
        associateButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                showMessage("Para associar um registro No-Show, você deve CANCELAR o registro atual e CRIAR um NOVO registro para Associação No-Show.");
            });
        });

        // Lógica de navegação com Tab/Enter (mantida)
        document.querySelectorAll('.card-actions form').forEach(form => {
            if (form.querySelector('.btn-associar.js-disable-manual-associate')) { // Verifica se é o form de associação manual
                const gaiolaInput = form.querySelector('input[name="gaiola"]');
                const estacaoInput = form.querySelector('input[name="estacao"]');
                const ruaInput = form.querySelector('input[name="rua"]');
                const salvarButton = form.querySelector('button[type="submit"]');

                if (gaiolaInput) {
                    gaiolaInput.addEventListener('keydown', function (event) {
                        if (event.key === 'Enter' || event.key === 'Tab') {
                            event.preventDefault();
                            if (estacaoInput) estacaoInput.focus();
                        }
                    });
                }
                if (estacaoInput) {
                    estacaoInput.addEventListener('keydown', function (event) {
                        if (event.key === 'Enter' || event.key === 'Tab') {
                            event.preventDefault();
                            if (ruaInput) ruaInput.focus();
                        }
                    });
                }
                if (ruaInput) {
                    ruaInput.addEventListener('keydown', function (event) {
                        if (event.key === 'Enter' || event.key === 'Tab') {
                            event.preventDefault();
                            if (salvarButton) salvarButton.focus();
                        }
                    });
                }
            }
        });

        // Lógica de cancelamento via Fetch (mantida do seu código)
        const cancelarNoshowForms = document.querySelectorAll('.cancelar-noshow-form');
        cancelarNoshowForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const registroId = this.dataset.registroId;
                fetch(`/cancelar_no_show/${registroId}`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        // Isso aqui só atualiza o status na UI, mas não recarrega toda a lista
                        // Se você quiser que a lista recarregue após o cancelamento,
                        // descomente a linha abaixo ou chame uma função de recarregamento
                        // window.location.href = '{{ url_for('registro_no_show') }}';
                        showMessage('Registro No-Show cancelado com sucesso!');
                        // Opcional: Atualizar o card especificamente sem recarregar a página
                        const card = document.getElementById(`no-show-registro-${registroId}`);
                        if (card) {
                            const statusLabel = card.querySelector('.status-label');
                            if (statusLabel) {
                                statusLabel.textContent = 'Cancelado';
                                statusLabel.className = 'status-label status-cancelado';
                            }
                            // Desabilitar botões após o cancelamento se desejar
                            card.querySelectorAll('.card-actions button').forEach(btn => btn.disabled = true);
                        }
                    } else {
                        console.error('Erro ao cancelar o registro No-Show.');
                        showMessage('Erro ao cancelar o registro No-Show.');
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição de cancelamento:', error);
                    showMessage('Erro na requisição de cancelamento.');
                });
            });
        });

        // Apenas para fins de exibição correta no Canvas,
        // as funções de fetch e atualização incremental estão removidas
        // pois elas dependem de um backend funcionando e de uma API específica,
        // que seu log indicou não estar acessível (404).
        // Se você precisa dessas funcionalidades, o problema deve ser resolvido no seu app.py.

    });
</script>
</body>
</html>
